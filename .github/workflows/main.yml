name: Convert Hosts Files

on:
  schedule:
    - cron: '0 14 * * *'   # 每天北京时间 22:00 执行
  workflow_dispatch:       # 支持手动运行

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo via HTTPS
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: Set Git Config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Checkout Repo via SSH
        run: |
          git remote set-url origin git@github.com:Mercury000/covert-adhost.git
          git fetch

      - name: Download reward.txt
        run: |
          curl -s -o reward.txt https://raw.githubusercontent.com/lingeringsound/10007_auto/refs/heads/master/reward

      - name: Download all.txt
        run: |
          curl -s -o all.txt https://raw.githubusercontent.com/lingeringsound/10007_auto/master/all

      - name: Process reward.txt -> reward.yaml
        run: |
          awk '
          BEGIN { skip=0 }

          # Skip lines between 自定义重定向hosts and END
          /^#自定义重定向hosts/,/^#END/ {
            if (/^#END/) skip=0;
            print >> "reward.yaml";
            next;
          }
          skip == 1 { print >> "reward.yaml"; next; }

          # Retain update time or specific comment lines
          /^#UpdateTime:/ { print >> "reward.yaml"; next; }

          # Skip empty lines
          /^[[:space:]]*$/ { next; }

          # Match 0.0.0.0 domain or IP
          $1 == "0.0.0.0" && NF > 1 {
            if ($2 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) {
              print "- IP-CIDR," $2 "/32" >> "reward.yaml"
            } else {
              print "- DOMAIN," $2 >> "reward.yaml"
            }
          }' reward.txt

          echo -e "#Mercury\n$(cat reward.yaml)" > reward.yaml.tmp && mv reward.yaml.tmp reward.yaml

      - name: Process all.txt -> all.yaml
        run: |
          awk '
          BEGIN { skip=0 }

          # Skip lines between 自定义重定向hosts and END
          /^#自定义重定向hosts/,/^#END/ {
            if (/^#END/) skip=0;
            print >> "all.yaml";
            next;
          }
          skip == 1 { print >> "all.yaml"; next; }

          # Retain update time or specific comment lines
          /^#UpdateTime:/ { print >> "all.yaml"; next; }

          # Skip empty lines
          /^[[:space:]]*$/ { next; }

          # Match 0.0.0.0 domain or IP
          $1 == "0.0.0.0" && NF > 1 {
            if ($2 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) {
              print "- IP-CIDR," $2 "/32" >> "all.yaml"
            } else {
              print "- DOMAIN," $2 >> "all.yaml"
            }
          }' all.txt

          echo -e "#Mercury\n$(cat all.yaml)" > all.yaml.tmp && mv all.yaml.tmp all.yaml

      - name: Show Output Files
        run: |
          echo "=== reward.yaml ==="
          cat reward.yaml
          echo ""
          echo "=== all.yaml ==="
          cat all.yaml

      - name: Commit and Push Changed Files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: "*.yaml"
          commit_message: Update yaml files from remote hosts