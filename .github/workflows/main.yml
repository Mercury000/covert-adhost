name: Convert Hosts Files

on:
  schedule:
    - cron: '0 7,15 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 15:00 23:00 æ‰§è¡Œ
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo via HTTPS
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: Set Git Config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Checkout Repo via SSH
        run: |
          git remote set-url origin git@github.com:Mercury000/covert-adhost.git
          git fetch

      - name: ä¸‹è½½ reward.txt å’Œ all.txt
        run: |
          curl -s -o reward.txt https://raw.githubusercontent.com/lingeringsound/10007_auto/refs/heads/master/reward
          curl -s -o all.txt https://raw.githubusercontent.com/lingeringsound/10007_auto/refs/heads/master/all

      - name: ç”Ÿæˆå½“å‰æ–‡ä»¶çš„ MD5 å€¼
        id: generate_md5
        run: |
          REWARD_MD5=$(md5sum reward.txt | awk '{print $1}')
          ALL_MD5=$(md5sum all.txt | awk '{print $1}')
          echo "REWARD_MD5=$REWARD_MD5" >> $GITHUB_ENV
          echo "ALL_MD5=$ALL_MD5" >> $GITHUB_ENV

      - name: åŠ è½½æˆ–åˆ›å»º md5_hashes.txt æ–‡ä»¶
        id: load_or_create_md5
        run: |
          if [ -f md5_hashes.txt ]; then
            source md5_hashes.txt
            echo "PREVIOUS_REWARD_MD5=${REWARD_MD5}" >> $GITHUB_ENV
            echo "PREVIOUS_ALL_MD5=${ALL_MD5}" >> $GITHUB_ENV
            echo "âœ… å·²åŠ è½½ä¸Šä¸€æ¬¡ä¿å­˜çš„ MD5 å€¼ã€‚"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° md5_hashes.txtï¼Œæ­£åœ¨åˆ›å»ºæ–°çš„å“ˆå¸Œè®°å½•æ–‡ä»¶..."
            echo "REWARD_MD5=${REWARD_MD5}" > md5_hashes.txt
            echo "ALL_MD5=${ALL_MD5}" >> md5_hashes.txt
            echo "PREVIOUS_REWARD_MD5=${REWARD_MD5}" >> $GITHUB_ENV
            echo "PREVIOUS_ALL_MD5=${ALL_MD5}" >> $GITHUB_ENV
            echo "ğŸ†• é¦–æ¬¡è¿è¡Œï¼šå·²ä¿å­˜åˆå§‹ MD5 å€¼åˆ° md5_hashes.txt"
          fi

      - name: æ¯”è¾ƒæ–°æ—§ MD5 å€¼
        run: |
          if [ "$REWARD_MD5" == "$PREVIOUS_REWARD_MD5" ] && [ "$ALL_MD5" == "$PREVIOUS_ALL_MD5" ]; then
            echo "âœ… æ–‡ä»¶è‡ªä¸Šæ¬¡è¿è¡Œä»¥æ¥æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡åç»­å¤„ç†ã€‚"
            exit 0
          else
            echo "ğŸ”„ æ–‡ä»¶å†…å®¹å·²æ›´æ”¹ï¼Œç»§ç»­æ‰§è¡Œè½¬æ¢ä»»åŠ¡ã€‚"
          fi

      - name: æ›´æ–°å¹¶ä¿å­˜å½“å‰ MD5 å€¼
        run: |
          echo "ğŸ’¾ æ­£åœ¨æ›´æ–° md5_hashes.txt æ–‡ä»¶ä¸­çš„ MD5 å€¼..."
          echo "REWARD_MD5=$REWARD_MD5" > md5_hashes.txt
          echo "ALL_MD5=$ALL_MD5" >> md5_hashes.txt

      - name: è½¬æ¢ reward.txt ä¸º YAML æ ¼å¼
        run: |
          awk '
          BEGIN { comment_section=1; update_time_line="" }

          /^#è‡ªå®šä¹‰é‡å®šå‘hosts/,/^#END/ {
            next;
          }

          /^#æ›´æ–°æ—¶é—´:/ {
            update_time_line=$0;
            next;
          }

          /^#/ { next; }

          /^[[:space:]]*$/ { next; }

          $1 == "0.0.0.0" && NF > 1 {
            if (comment_section) {
              print "#Mercury\n#10007";
              if (update_time_line != "") {
                print update_time_line;
              }
              print "payload:";
              comment_section=0;
            }
            if ($2 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) {
              print "- IP-CIDR," $2 "/32"
            } else {
              print "- DOMAIN," $2
            }
          }' reward.txt > reward.yaml

      - name: è½¬æ¢ all.txt ä¸º YAML æ ¼å¼
        run: |
          awk '
          BEGIN { comment_section=1; update_time_line="" }

          /^#è‡ªå®šä¹‰é‡å®šå‘hosts/,/^#END/ {
            next;
          }

          /^#æ›´æ–°æ—¶é—´:/ {
            update_time_line=$0;
            next;
          }

          /^#/ { next; }

          /^[[:space:]]*$/ { next; }

          $1 == "0.0.0.0" && NF > 1 {
            if (comment_section) {
              print "#Mercury\n#10007";
              if (update_time_line != "") {
                print update_time_line;
              }
              print "payload:";
              comment_section=0;
            }
            if ($2 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) {
              print "- IP-CIDR," $2 "/32"
            } else {
              print "- DOMAIN," $2
            }
          }' all.txt > all.yaml

      - name: æ˜¾ç¤ºç”Ÿæˆçš„ YAML æ–‡ä»¶å†…å®¹
        run: |
          echo "ğŸ“„ reward.yaml å†…å®¹å¦‚ä¸‹ï¼š"
          cat reward.yaml
          echo ""
          echo "ğŸ“„ all.yaml å†…å®¹å¦‚ä¸‹ï¼š"
          cat all.yaml

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: "*.yaml md5_hashes.txt"
          commit_message: æ›´æ–°è¿œç¨‹ hosts æ–‡ä»¶ç”Ÿæˆçš„ YAML å’Œ MD5 å“ˆå¸Œå€¼