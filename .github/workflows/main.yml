name: Convert Hosts Files

on:
Â Â schedule:
Â Â Â Â -Â cron:Â '0Â 7,15Â *Â *Â *'Â Â Â #Â æ¯å¤©åŒ—äº¬æ—¶é—´Â 15:00Â 23:00Â æ‰§è¡Œ
Â Â workflow_dispatch:Â Â Â Â Â Â Â Â #Â æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

jobs:
Â Â convert:
Â Â Â Â runs-on:Â ubuntu-latest
Â Â Â Â steps:
Â Â Â Â Â Â -Â name:Â æ£€å‡ºä»“åº“
Â Â Â Â Â Â Â Â uses:Â actions/checkout@v4

Â Â Â Â Â Â -Â name:Â è®¾ç½®Â SSHÂ å¯†é’¥
Â Â Â Â Â Â Â Â uses:Â webfactory/ssh-agent@v0.5.1
Â Â Â Â Â Â Â Â with:
Â Â Â Â Â Â Â Â Â Â ssh-private-key:Â ${{Â secrets.ACTIONS_DEPLOY_KEYÂ }}

Â Â Â Â Â Â -Â name:Â é…ç½®Â GitÂ ç”¨æˆ·ä¿¡æ¯
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â gitÂ configÂ --globalÂ user.nameÂ "${{Â github.actorÂ }}"
Â Â Â Â Â Â Â Â Â Â gitÂ configÂ --globalÂ user.emailÂ "${{Â github.actorÂ }}@users.noreply.github.com"
Â Â Â Â Â Â Â Â Â Â gitÂ remoteÂ set-urlÂ originÂ git@github.com:Mercury000/covert-adhost.git
Â Â Â Â Â Â Â Â Â Â gitÂ fetch

Â Â Â Â Â Â -Â name:Â ä¸‹è½½Â reward.txtÂ å’ŒÂ all.txt
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â curlÂ -sÂ -oÂ reward.txtÂ https://raw.githubusercontent.com/lingeringsound/10007_auto/refs/heads/master/reward
Â Â Â Â Â Â Â Â Â Â curlÂ -sÂ -oÂ all.txtÂ https://raw.githubusercontent.com/lingeringsound/10007_auto/refs/heads/master/all

Â Â Â Â Â Â -Â name:Â ç”Ÿæˆå½“å‰æ–‡ä»¶çš„Â MD5Â å€¼
Â Â Â Â Â Â Â Â id:Â generate_md5
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â REWARD_MD5=$(md5sumÂ reward.txtÂ |Â awkÂ '{printÂ $1}')
Â Â Â Â Â Â Â Â Â Â ALL_MD5=$(md5sumÂ all.txtÂ |Â awkÂ '{printÂ $1}')
Â Â Â Â Â Â Â Â Â Â echoÂ "REWARD_MD5=$REWARD_MD5"Â >>Â $GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â echoÂ "ALL_MD5=$ALL_MD5"Â >>Â $GITHUB_ENV

Â Â Â Â Â Â -Â name:Â åŠ è½½æˆ–åˆ›å»ºÂ md5_hashes.txt
Â Â Â Â Â Â Â Â id:Â load_or_create_md5
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â ifÂ [Â !Â -fÂ md5_hashes.txtÂ ];Â then
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "âš ï¸Â æœªæ‰¾åˆ°Â md5_hashes.txtï¼Œæ­£åœ¨åˆ›å»ºæ–°çš„å“ˆå¸Œè®°å½•æ–‡ä»¶..."
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "REWARD_MD5=$REWARD_MD5"Â >Â md5_hashes.txt
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "ALL_MD5=$ALL_MD5"Â >>Â md5_hashes.txt
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "PREVIOUS_REWARD_MD5=$REWARD_MD5"Â >>Â $GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "PREVIOUS_ALL_MD5=$ALL_MD5"Â >>Â $GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "NEED_UPDATE=true"Â >>$GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "ğŸ†•Â é¦–æ¬¡è¿è¡Œï¼šå·²ä¿å­˜åˆå§‹Â MD5Â å€¼åˆ°Â md5_hashes.txt"
Â Â Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â sourceÂ md5_hashes.txt
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "PREVIOUS_REWARD_MD5=$REWARD_MD5"Â >>$GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "PREVIOUS_ALL_MD5=$ALL_MD5"Â >>$GITHUB_ENV
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "âœ…Â å·²åŠ è½½ä¸Šä¸€æ¬¡ä¿å­˜çš„Â MD5Â å€¼ã€‚"
Â Â Â Â Â Â Â Â Â Â fi

Â Â Â Â Â Â -Â name:Â åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
Â Â Â Â Â Â Â Â id:Â check_update
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â NEED_UPDATE=false
Â Â Â Â Â Â Â Â Â Â ifÂ [Â "$NEED_UPDATE"Â =Â "true"Â ];Â then
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "âœ…Â å·²æ ‡è®°ä¸ºéœ€è¦æ›´æ–°ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰ï¼Œå‡†å¤‡æ‰§è¡Œè½¬æ¢ä»»åŠ¡ã€‚"
Â Â Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ [Â "$REWARD_MD5"Â !=Â "$PREVIOUS_REWARD_MD5"Â ]Â ||Â [Â "$ALL_MD5"Â !=Â "$PREVIOUS_ALL_MD5"Â ];Â then
Â Â Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "ğŸ”„Â æ£€æµ‹åˆ°Â reward.txtÂ æˆ–Â all.txtÂ å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå‡†å¤‡æ‰§è¡Œè½¬æ¢ä»»åŠ¡ã€‚"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â NEED_UPDATE=true
Â Â Â Â Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â Â Â echoÂ "âœ…Â æ–‡ä»¶è‡ªä¸Šæ¬¡è¿è¡Œä»¥æ¥æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡åç»­å¤„ç†ã€‚"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â exitÂ 0
Â Â Â Â Â Â Â Â Â Â Â Â fi
Â Â Â Â Â Â Â Â Â Â fi
Â Â Â Â Â Â Â Â Â Â echoÂ "NEED_UPDATE=$NEED_UPDATE"Â >>Â $GITHUB_ENV

Â Â Â Â Â Â -Â name:Â æ›´æ–°å¹¶ä¿å­˜å½“å‰Â MD5Â å€¼
Â Â Â Â Â Â Â Â if:Â env.NEED_UPDATEÂ ==Â 'true'
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â echoÂ "ğŸ’¾Â æ­£åœ¨æ›´æ–°Â md5_hashes.txtÂ æ–‡ä»¶ä¸­çš„Â MD5Â å€¼..."
Â Â Â Â Â Â Â Â Â Â echoÂ "REWARD_MD5=$REWARD_MD5"Â >Â md5_hashes.txt
Â Â Â Â Â Â Â Â Â Â echoÂ "ALL_MD5=$ALL_MD5"Â >>Â md5_hashes.txt

Â Â Â Â Â Â -Â name:Â ç»Ÿä¸€è½¬æ¢Â hostsÂ æ–‡ä»¶ä¸ºÂ YAMLÂ æ ¼å¼
Â Â Â Â Â Â Â Â if:Â env.NEED_UPDATEÂ ==Â 'true'
Â Â Â Â Â Â Â Â run:Â |
Â Â Â Â Â Â Â Â Â Â process_file()Â {
Â Â Â Â Â Â Â Â Â Â Â Â input="$1"
Â Â Â Â Â Â Â Â Â Â Â Â output="${input%.txt}.yaml"
Â Â Â Â Â Â Â Â Â Â Â Â awkÂ '
Â Â Â Â Â Â Â Â Â Â Â Â BEGINÂ {Â c=1;Â u=""Â }
Â Â Â Â Â Â Â Â Â Â Â Â /^#è‡ªå®šä¹‰é‡å®šå‘hosts/,/^#END/Â {Â nextÂ }
Â Â Â Â Â Â Â Â Â Â Â Â /^#æ›´æ–°æ—¶é—´:/Â {Â u=$0;Â nextÂ }
Â Â Â Â Â Â Â Â Â Â Â Â /^#/Â {Â nextÂ }
Â Â Â Â Â Â Â Â Â Â Â Â /^[[:space:]]*$/Â {Â nextÂ }
Â Â Â Â Â Â Â Â Â Â Â $1Â ==Â "0.0.0.0"Â &&Â NFÂ >Â 1Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (c)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â printÂ "#Mercury\n#10007";
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (uÂ !=Â "")Â printÂ u;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â printÂ "payload:";
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â c=0;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ ($2Â ~Â /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â printÂ "-Â IP-CIDR,"Â $2Â "/32"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â printÂ "-Â DOMAIN,"$2
Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }'Â "$input"Â >Â "$output"
Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â process_fileÂ "reward.txt"
Â Â Â Â Â Â Â Â Â Â process_fileÂ "all.txt"

Â Â Â Â Â Â -Â name:Â æäº¤å¹¶æ¨é€æ›´æ”¹
Â Â Â Â Â Â Â Â if:Â env.NEED_UPDATEÂ ==Â 'true'
Â Â Â Â Â Â Â Â uses:Â stefanzweifel/git-auto-commit-action@v4
Â Â Â Â Â Â Â Â with:
Â Â Â Â Â Â Â Â Â Â file_pattern:Â "*.yamlÂ md5_hashes.txt"
Â Â Â Â Â Â Â Â Â Â commit_message:Â æ›´æ–°è¿œç¨‹Â hostsÂ æ–‡ä»¶ç”Ÿæˆçš„Â YAMLÂ å’ŒÂ MD5Â å“ˆå¸Œå€¼
