name: Convert Hosts File

on:
  schedule:
    - cron: '0 0 * * *'  # 每天执行一次
  workflow_dispatch:     # 手动运行

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo via HTTPS
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: Set Git Config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Checkout Repo via SSH
        run: |
          git remote set-url origin git@github.com:Mercury000/covert-adhost.git
          git fetch

      - name: Download Hosts File
        run: |
          curl -s -o reward.txt https://raw.githubusercontent.com/lingeringsound/10007_auto/refs/heads/master/reward

      - name: Process Hosts File
        id: process
        run: |
          awk '
          BEGIN { skip=0 }
          $0 ~ /^#自定义重定向hosts/ { skip=1 }
          $0 ~ /^#END/ { skip=0; next }
          skip == 1 { next }
          /^[[:space:]]*$/ { next }
          {
            if ($1 == "0.0.0.0") {
              gsub(/^.*\./, "", $2);
              print "- DOMAIN," $2
            }
          }' reward.txt > adhosts.yaml

      - name: Show Output File
        run: cat adhosts.yaml

      - name: Commit and Push if Changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: adhosts.yaml
          commit_message: Update adhosts.yaml from remote hosts file
          repository: .
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: Mercury000 <Mercury000@users.noreply.github.com